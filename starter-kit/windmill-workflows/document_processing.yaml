# Document Processing Flow
#
# This Windmill Flow configuration processes uploaded documents,
# extracts data, and triggers appropriate workflows.
#
# To import in Windmill:
# 1. Create a new Flow in Windmill UI
# 2. Switch to YAML mode
# 3. Paste this configuration
# 4. Save as "document_processing"

summary: Document Processing Pipeline
description: Process uploaded documents with OCR, data extraction, and validation

value:
  modules:
    # Step 1: Receive document upload event
    - id: receive_document
      summary: Receive Document Upload
      value:
        type: rawscript
        language: typescript
        content: |
          export async function main(input: {
            document_id: string;
            project_id: string;
            document_type: string;
            file_name: string;
            s3_bucket: string;
            s3_key: string;
            uploaded_by: string;
          }) {
            console.log(`Processing document: ${input.file_name}`);
            console.log(`Type: ${input.document_type}`);
            console.log(`Project: ${input.project_id}`);

            // Validate input
            if (!input.s3_bucket || !input.s3_key) {
              throw new Error('S3 location not provided');
            }

            return {
              ...input,
              processing_started_at: new Date().toISOString()
            };
          }

    # Step 2: Download from S3
    - id: download_from_s3
      summary: Download Document from S3
      value:
        type: rawscript
        language: typescript
        content: |
          import { S3Client, GetObjectCommand } from '@aws-sdk/client-s3';

          export async function main(input: any) {
            const s3Client = new S3Client({
              endpoint: 'http://localstack:4566',
              region: 'us-west-2',
              credentials: {
                accessKeyId: 'test',
                secretAccessKey: 'test'
              },
              forcePathStyle: true
            });

            try {
              const command = new GetObjectCommand({
                Bucket: input.s3_bucket,
                Key: input.s3_key
              });

              const response = await s3Client.send(command);
              const fileContent = await streamToBuffer(response.Body);

              return {
                ...input,
                file_size: fileContent.length,
                content_type: response.ContentType,
                download_success: true
              };
            } catch (error) {
              console.error('S3 download failed:', error);
              return {
                ...input,
                download_success: false,
                error: error.message
              };
            }
          }

          async function streamToBuffer(stream: any): Promise<Buffer> {
            const chunks = [];
            for await (const chunk of stream) {
              chunks.push(chunk);
            }
            return Buffer.concat(chunks);
          }

    # Step 3: Determine processing type
    - id: determine_processing
      summary: Determine Processing Type
      value:
        type: rawscript
        language: typescript
        content: |
          export async function main(input: any) {
            const documentProcessors: Record<string, string> = {
              'SURVEY': 'extract_survey_data',
              'TITLE_REPORT': 'extract_title_data',
              'ARBORIST_REPORT': 'extract_arborist_data',
              'PROFORMA': 'extract_financial_data',
              'SITE_PLAN': 'extract_site_plan_data',
              'CONTRACT': 'extract_contract_terms',
              'PERMIT': 'extract_permit_data'
            };

            const processor = documentProcessors[input.document_type] || 'generic_extraction';

            return {
              ...input,
              processor_type: processor,
              requires_ocr: ['SURVEY', 'PERMIT', 'CONTRACT'].includes(input.document_type),
              requires_validation: ['PROFORMA', 'CONTRACT'].includes(input.document_type)
            };
          }

    # Step 4: Conditional OCR processing
    - id: ocr_if_needed
      summary: OCR Processing (if needed)
      value:
        type: rawscript
        language: typescript
        suspend:
          required_events: 1
          timeout: 300  # 5 minute timeout
        content: |
          export async function main(input: any) {
            if (!input.requires_ocr) {
              return {
                ...input,
                ocr_performed: false
              };
            }

            // In production, this would call AWS Textract or similar
            console.log('Performing OCR on document...');

            // Simulate OCR processing
            await new Promise(resolve => setTimeout(resolve, 2000));

            return {
              ...input,
              ocr_performed: true,
              extracted_text: 'Sample extracted text from document...',
              ocr_confidence: 0.95
            };
          }

    # Step 5: Extract structured data
    - id: extract_data
      summary: Extract Structured Data
      value:
        type: rawscript
        language: typescript
        content: |
          export async function main(input: any) {
            // Simulate data extraction based on document type
            let extractedData: any = {
              document_id: input.document_id,
              extraction_timestamp: new Date().toISOString()
            };

            switch (input.document_type) {
              case 'SURVEY':
                extractedData = {
                  ...extractedData,
                  lot_size: '7,500 sq ft',
                  setbacks: { front: 20, rear: 15, side: 5 },
                  easements: [],
                  encroachments: false
                };
                break;

              case 'PROFORMA':
                extractedData = {
                  ...extractedData,
                  total_cost: 2500000,
                  construction_cost: 1800000,
                  land_cost: 500000,
                  soft_costs: 200000,
                  projected_revenue: 3200000,
                  projected_roi: 0.28
                };
                break;

              case 'CONTRACT':
                extractedData = {
                  ...extractedData,
                  parties: ['Blueprint', 'Builder LLC'],
                  effective_date: '2024-01-01',
                  terms: ['Payment terms: Net 30', 'Completion: 180 days'],
                  total_value: 2000000
                };
                break;

              default:
                extractedData = {
                  ...extractedData,
                  raw_data: input.extracted_text || 'No structured data extracted'
                };
            }

            return {
              ...input,
              extracted_data: extractedData
            };
          }

    # Step 6: Validate extracted data
    - id: validate_data
      summary: Validate Extracted Data
      value:
        type: rawscript
        language: typescript
        content: |
          export async function main(input: any) {
            const validationErrors: string[] = [];
            const validationWarnings: string[] = [];

            // Perform validation based on document type
            if (input.document_type === 'PROFORMA') {
              const data = input.extracted_data;

              if (data.total_cost <= 0) {
                validationErrors.push('Total cost must be positive');
              }

              if (data.projected_roi < 0.15) {
                validationWarnings.push('ROI below typical threshold of 15%');
              }

              if (data.construction_cost > data.total_cost * 0.8) {
                validationWarnings.push('Construction costs exceed 80% of total');
              }
            }

            if (input.document_type === 'CONTRACT') {
              const data = input.extracted_data;

              if (!data.effective_date) {
                validationErrors.push('Contract missing effective date');
              }

              if (data.total_value <= 0) {
                validationErrors.push('Contract value must be positive');
              }
            }

            return {
              ...input,
              validation_performed: true,
              validation_errors: validationErrors,
              validation_warnings: validationWarnings,
              is_valid: validationErrors.length === 0
            };
          }

    # Step 7: Update database
    - id: update_database
      summary: Update Database with Results
      value:
        type: postgresql
        database: connect2
        query: |
          UPDATE documents
          SET metadata = metadata || $1::jsonb,
              updated_at = NOW()
          WHERE id = $2::uuid
          RETURNING *;
        args:
          - name: metadata
            expr: |
              {
                "processing_completed": true,
                "extracted_data": flow.extract_data.extracted_data,
                "validation_errors": flow.validate_data.validation_errors,
                "validation_warnings": flow.validate_data.validation_warnings,
                "ocr_performed": flow.ocr_if_needed.ocr_performed,
                "processor_used": flow.determine_processing.processor_type
              }
          - name: document_id
            expr: flow.receive_document.document_id

    # Step 8: Trigger follow-up workflows
    - id: trigger_followup
      summary: Trigger Follow-up Workflows
      value:
        type: rawscript
        language: typescript
        content: |
          export async function main(input: any) {
            const triggeredWorkflows: string[] = [];

            // Determine which workflows to trigger based on document type and validation
            if (input.is_valid) {
              switch (input.document_type) {
                case 'SURVEY':
                  triggeredWorkflows.push('feasibility_analysis');
                  break;

                case 'PROFORMA':
                  if (input.extracted_data.projected_roi >= 0.20) {
                    triggeredWorkflows.push('loan_pre_approval');
                  } else {
                    triggeredWorkflows.push('manual_review');
                  }
                  break;

                case 'CONTRACT':
                  triggeredWorkflows.push('contract_review');
                  triggeredWorkflows.push('legal_compliance_check');
                  break;

                case 'PERMIT':
                  triggeredWorkflows.push('update_entitlement_status');
                  break;
              }
            } else {
              // If validation failed, trigger manual review
              triggeredWorkflows.push('manual_document_review');
            }

            return {
              ...input,
              triggered_workflows: triggeredWorkflows,
              processing_complete: true,
              completion_time: new Date().toISOString()
            };
          }

    # Step 9: Send notifications
    - id: send_notifications
      summary: Send Completion Notifications
      value:
        type: rawscript
        language: typescript
        content: |
          export async function main(input: any) {
            const notifications = [];

            // Notify uploader
            notifications.push({
              type: 'email',
              to: input.uploaded_by,
              subject: `Document Processed: ${input.file_name}`,
              body: `Your ${input.document_type} document has been processed.`
            });

            // If validation failed, notify project manager
            if (!input.is_valid) {
              notifications.push({
                type: 'slack',
                channel: '#document-errors',
                message: `⚠️ Validation failed for ${input.file_name}: ${input.validation_errors.join(', ')}`
              });
            }

            // If high-value contract, notify executives
            if (input.document_type === 'CONTRACT' && input.extracted_data?.total_value > 5000000) {
              notifications.push({
                type: 'email',
                to: 'executives@blueprint.com',
                subject: 'High-Value Contract Uploaded',
                body: `Contract value: $${input.extracted_data.total_value}`
              });
            }

            console.log(`Sending ${notifications.length} notifications`);

            return {
              success: true,
              document_id: input.document_id,
              processing_summary: {
                document_type: input.document_type,
                ocr_performed: input.ocr_performed,
                data_extracted: !!input.extracted_data,
                validation_passed: input.is_valid,
                workflows_triggered: input.triggered_workflows,
                notifications_sent: notifications.length
              }
            };
          }

# Flow configuration
schema:
  type: object
  properties:
    document_id:
      type: string
      description: UUID of the document record
    project_id:
      type: string
      description: UUID of the associated project
    document_type:
      type: string
      enum: [SURVEY, TITLE_REPORT, ARBORIST_REPORT, PROFORMA, SITE_PLAN, CONTRACT, PERMIT]
      description: Type of document being processed
    file_name:
      type: string
      description: Original filename
    s3_bucket:
      type: string
      description: S3 bucket name
    s3_key:
      type: string
      description: S3 object key
    uploaded_by:
      type: string
      description: Email of the user who uploaded the document
  required:
    - document_id
    - project_id
    - document_type
    - file_name
    - s3_bucket
    - s3_key
    - uploaded_by
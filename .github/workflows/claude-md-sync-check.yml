name: CLAUDE.md Sync Check

# This workflow ensures CLAUDE.md stays in sync across all feature branches
# It checks if developers have the latest version when they create PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  check-claude-md-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0  # Fetch all history for comparison

      - name: Check if CLAUDE.md is in sync with main
        run: |
          echo "Checking if CLAUDE.md is synced with main..."

          # Fetch main branch
          git fetch origin main

          # Compare CLAUDE.md between PR branch and main
          if git diff origin/main HEAD -- CLAUDE.md | grep -q '^[+-]'; then
            echo "⚠️ WARNING: CLAUDE.md differs from main branch"
            echo ""
            echo "Your branch has modifications to CLAUDE.md."
            echo ""
            echo "If you made intentional improvements to CLAUDE.md:"
            echo "  1. Create a separate PR for just CLAUDE.md changes"
            echo "  2. Get that merged first"
            echo "  3. Rebase this PR on updated main"
            echo ""
            echo "If you didn't mean to modify CLAUDE.md:"
            echo "  1. Merge latest main: git merge origin/main"
            echo "  2. Resolve any conflicts by keeping main version"
            echo ""
            echo "Diff:"
            git diff origin/main HEAD -- CLAUDE.md

            # Don't fail the build, just warn
            exit 0
          else
            echo "✅ CLAUDE.md is in sync with main"
          fi

      - name: Check if CLAUDE.md exists
        run: |
          if [ ! -f "CLAUDE.md" ]; then
            echo "❌ ERROR: CLAUDE.md is missing from this branch"
            echo "Run: git checkout main -- CLAUDE.md"
            exit 1
          fi

      - name: Post comment on PR if out of sync
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // Check if CLAUDE.md differs
            try {
              execSync('git diff origin/main HEAD -- CLAUDE.md | grep -q "^[+-]"');

              // If we get here, there are differences
              const comment = `## ⚠️ CLAUDE.md Sync Warning

              Your branch has modifications to \`CLAUDE.md\` that differ from \`main\`.

              **If you made intentional improvements to CLAUDE.md:**
              1. Create a separate PR for just CLAUDE.md changes
              2. Get that merged first
              3. Rebase this PR on updated main

              **If you didn't mean to modify CLAUDE.md:**
              \`\`\`bash
              git fetch origin main
              git checkout origin/main -- CLAUDE.md
              git commit -m "sync: Restore CLAUDE.md from main"
              git push
              \`\`\`

              **Why this matters:** CLAUDE.md contains project-wide AI assistant instructions that should stay consistent across all developers.`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              // No differences found, CLAUDE.md is in sync
              console.log('✅ CLAUDE.md is in sync');
            }
